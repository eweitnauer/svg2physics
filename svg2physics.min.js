// Copyright Erik Weitnauer 2014.
s2p=function(){var t={version:"1.0.0"};var e=Box2D.Dynamics.b2BodyDef,i=Box2D.Dynamics.b2Body,s=Box2D.Common.Math.b2Vec2,o=Box2D.Collision.Shapes.b2Shape,r=Box2D.Collision.Shapes.b2CircleShape,n=Box2D.Collision.Shapes.b2PolygonShape,a=Box2D.Dynamics.b2FixtureDef,h=Box2D.Collision.b2AABB;Box2DAdapter=function(){var t=this;this.rel_curve_error_margin=.08;this.linear_damping=.35;this.angular_damping=.35;this.cd_settings={max_vertices:32,preprocess:true,pre_order_vertices:true,pre_merge_vertices_min_dist:.01,pre_remove_vertices_max_error:0,postprocess:false,post_move_vertices_inside_dist:.02,debug_text:false}};Box2DAdapter.prototype.loadScene=function(t,e){var i=e.friction;var s=e.restitution;var o=1/e.pixels_per_unit;var r=this;var n=true;e.shapes.forEach(function(e){var n=1;var a=/^[0-9]*\.?[0-9]+/;if(a.test(e.style["stroke-width"])){n=Number(a.exec(e.style["stroke-width"])[0])}var h=Box2D.Common.b2Settings.b2_linearSlop;var l=e.copy();var p=e.bounding_box();var c=(p.width+n)/(p.width+h);var u=(p.height+n)/(p.height+h);if(l instanceof Polygon){l.pts.forEach(function(t){t.Scale(o)});if(e.movable){l.pts.forEach(function(t){t.x*=c;t.y*=u})}else if(e.id=="_"){l.pts.forEach(function(t){t.y+=(h-n)*o/4})}}else if(l instanceof Circle){l.r=(l.r+n/2)*o}else throw"Unknown object type.";e.phys_scale=o;e.synch_to_phys=function(){this.x=this.phys_obj.GetPosition().x/this.phys_scale;this.y=this.phys_obj.GetPosition().y/this.phys_scale;this.rot=this.phys_obj.GetAngle()};e.phys_obj=r.createBody(t,l,e.movable,e.x*o,e.y*o,0,1,i,s);e.phys_obj.master_obj=e;e.rot=0})};Box2DAdapter.prototype.createBody=function(t,s,o,r,n,a,h,l,p){var c=new e;if(o)c.type=i.b2_dynamicBody;c.position.Set(r,n);c.angle=a;c.angularDamping=this.angular_damping;c.linearDamping=this.linear_damping;var u=t.CreateBody(c);var m={density:h,friction:l,restitution:p};this.add_fixture(s,u,m,o);return u};Box2DAdapter.prototype.add_fixture=function(t,e,i,o){if(t instanceof Circle){var h=new r(t.r);var l=new a;obj_extend(l,i);l.shape=h;e.CreateFixture(l)}else if(t instanceof Polygon){var p=t;if(o){var c=p.convex_decomposition(this.cd_settings);c.forEach(function(t){var s=n.AsVector(t.pts);var o=new a;obj_extend(o,i);o.shape=s;e.CreateFixture(o)})}else{var u=p.pts.length;if(u<2)return;for(var m=0;m<u;++m){if(m==u-1&&!p.closed)break;var f=m==u-1?0:m+1;var h=n.AsVector([new s(p.pts[m].x,p.pts[m].y),new s(p.pts[f].x,p.pts[f].y)]);var l=new a;obj_extend(l,i);l.shape=h;e.CreateFixture(l)}}}else throw"Unkown shape type!"};obj_extend=function(t,e){for(x in e){if(e.hasOwnProperty(x))t[x]=e[x]}};obj_extended=function(t,e){var i={};for(x in t){if(t.hasOwnProperty(x))i[x]=t[x]}for(x in e){if(e.hasOwnProperty(x))i[x]=e[x]}return i};t.Box2DAdapter=Box2DAdapter;var i=Box2D.Dynamics.b2Body,l=Box2D.Dynamics.b2World,p=Box2D.Common.Math.b2Transform,c=Box2D.Common.Math.b2Sweep,u=Box2D.Collision.b2DistanceInput,m=Box2D.Collision.b2DistanceOutput,f=Box2D.Collision.b2DistanceProxy,y=Box2D.Collision.b2SimplexCache,d=Box2D.Collision.b2Distance,s=Box2D.Common.Math.b2Vec2,e=Box2D.Dynamics.b2BodyDef,a=Box2D.Dynamics.b2FixtureDef,n=Box2D.Collision.Shapes.b2PolygonShape,r=Box2D.Collision.Shapes.b2CircleShape,h=Box2D.Collision.b2AABB;s.prototype.Transformed=function(t){return new s(this.x*t.R.col1.x+this.y*t.R.col2.x+t.position.x,this.x*t.R.col1.y+this.y*t.R.col2.y+t.position.y)};i.prototype.IsCircle=function(){return this.m_fixtureList.m_shape instanceof r&&this.m_fixtureList.m_next==null};i.prototype.distance=function(t){var e=function(t,e,i,s){var o=new u;o.proxyA=new f;o.proxyA.Set(t);o.proxyB=new f;o.proxyB.Set(i);o.transformA=e;o.transformB=s;o.useRadii=true;var r=new y;r.count=0;var n=new m;d.Distance(n,r,o);return n.distance};var i=Infinity;for(var s=this.m_fixtureList;s;s=s.m_next){for(var o=t.m_fixtureList;o;o=o.m_next){var r=e(s.m_shape,this.GetTransform(),o.m_shape,t.GetTransform());if(i>r)i=r}}return i};i.prototype.setCollisionFilter=function(t){var e;for(var i=this.m_fixtureList;i;i=i.m_next){e=i.GetFilterData();if("maskBits"in t)e.maskBits=t.maskBits;if("categoryBits"in t)e.categoryBits=t.categoryBits;if("groupIndex"in t)e.groupIndex=t.groupIndex;i.SetFilterData(e)}};function _(t){this.Init(t)}_.prototype.Init=function(t){this.m_flags=t.m_flags;this.m_xf=new p;this.m_xf.Set(t.m_xf);this.m_sweep=new c;this.m_sweep.Set(t.m_sweep);this.m_linearVelocity=t.m_linearVelocity.Copy();this.m_angularVelocity=t.m_angularVelocity;this.m_linearDamping=t.m_linearDamping;this.m_angularDamping=t.m_angularDamping;this.m_force=t.m_force.Copy();this.m_torque=t.m_torque;this.m_sleepTime=t.m_sleepTime;this.m_type=t.m_type;this.m_mass=t.m_mass;this.m_invMass=t.m_invMass;this.m_I=t.m_I;this.m_invI=t.m_invI;this.m_inertiaScale=t.m_inertiaScale;this.m_islandIndex=t.m_islandIndex};_.prototype.Apply=function(t){t.m_xf.Set(this.m_xf);t.m_sweep.Set(this.m_sweep);t.m_linearVelocity=this.m_linearVelocity.Copy();t.m_angularVelocity=this.m_angularVelocity;t.m_linearDamping=this.m_linearDamping;t.m_angularDamping=this.m_angularDamping;t.m_force=this.m_force.Copy();t.m_torque=this.m_torque;t.m_sleepTime=this.m_sleepTime;t.m_type=this.m_type;t.m_mass=this.m_mass;t.m_invMass=this.m_invMass;t.m_I=this.m_I;t.m_invI=this.m_invI;t.m_inertiaScale=this.m_inertiaScale;t.m_islandIndex=this.m_islandIndex;if((this.m_flags&i.e_activeFlag)==i.e_activeFlag){t.SetActive(true)}if((this.m_flags&i.e_awakeFlag)==i.e_awakeFlag){t.SetAwake(true)}t.m_flags=this.m_flags;t.SynchronizeFixtures()};function v(t){this.Init(t)}v.prototype.Init=function(t){this.curr_time=t.curr_time};v.prototype.Apply=function(t){t.curr_time=this.curr_time};i.prototype.PushState=function(){if(!this.bodystates)this.bodystates=[];this.bodystates.push(new _(this))};i.prototype.PopState=function(){this.bodystates.pop().Apply(this)};l.prototype.PushState=function(){if(!this.worldstates)this.worldstates=[];this.worldstates.push(new v(this));for(var t=this.m_bodyList;t;t=t.m_next){if(t.m_type==i.b2_dynamicBody)t.PushState()}};l.prototype.PopState=function(){this.worldstates.pop().Apply(this);for(var t=this.m_bodyList;t;t=t.m_next){if(t.m_type==i.b2_dynamicBody)t.PopState()}this.m_contactManager.FindNewContacts()};l.prototype.GetState=function(){var t=[];t.push({el:this,state:new v(this)});for(var e=this.m_bodyList;e;e=e.m_next){if(e.m_type==i.b2_dynamicBody)t.push({el:e,state:new _(e)})}return t};l.prototype.SetState=function(t){t.forEach(function(t){t.state.Apply(t.el)})};var g=Box2D.Dynamics.b2DebugDraw,w=Box2D.Dynamics.Joints.b2MouseJointDef;Simulator=function(t,e,i,s,o){this.canvas=e;this.ctx=e.getContext("2d");this.pscene=t;this.step_interval=1e3/30;this.interaction_interval=1e3/30;this.show_time=s||true;this.show_pos=false;this.draw_scale=i||1;this.playing=false;this.drawing=true;this.auto_pause=o===undefined?true:o;this.init();this.draw()};Simulator.prototype.release=function(){if(this.step_timer)clearInterval(this.step_timer);if(this.interaction_timer)clearInterval(this.interaction_timer);this.pscene.onWorldChange.removeListener(this.draw)};Simulator.prototype.pause=function(){this.was_autopaused=false;if(!this.playing)return;clearInterval(this.step_timer);this.step_time=null;this.playing=false};Simulator.prototype.play=function(){if(this.playing)return;var t=this;t.was_autopaused=false;this.step_timer=setInterval(function(){t.pscene.step();if(t.auto_pause&&t.pscene.countAwake()==0){t.pause();t.was_autopaused=true}},this.step_interval);this.playing=true};Simulator.prototype.toggle=function(){if(this.playing)this.pause();else this.play()};Simulator.prototype.reset=function(){this.pscene.reset()};Simulator.prototype.init=function(){var t=this;this.dbgDraw=new g;this.dbgDraw.SetSprite(this.canvas.getContext("2d"));this.dbgDraw.SetDrawScale(this.draw_scale);this.dbgDraw.SetXFormScale(.1);this.dbgDraw.SetFillAlpha(.5);this.dbgDraw.SetLineThickness(1);this.dbgDraw.SetFlags(g.e_shapeBit|g.e_jointBit);this.pscene.world.SetDebugDraw(this.dbgDraw);this.pscene.onWorldChange.addListener(function(){t.draw.apply(t)});this.mouseDown=false;this.mousePoint=new s(0,0);this.canvas.addEventListener("mousemove",function(){t.handleMouseMove.apply(t,arguments)},true);this.canvas.addEventListener("mousedown",function(){t.mouseDown=true},true);this.canvas.addEventListener("mouseup",function(){if(!t.mouseJoint)t.toggle.apply(t);t.handleMouseUp.apply(t,arguments)},true);this.canvas.addEventListener("dblclick",function(){t.pause();t.reset()},true);this.interaction_timer=setInterval(function(){t.updateInteraction.apply(t)},this.interaction_interval);this.canvas_position=this.getElementPosition(this.canvas);window.addEventListener("scroll",function(){t.canvas_position=t.getElementPosition(t.canvas)})};Simulator.prototype.getElementPosition=function(t){var e=t.offsetLeft-document.documentElement.scrollLeft,i=t.offsetTop-document.documentElement.scrollTop;while(t=t.offsetParent){e+=t.offsetLeft-t.scrollLeft;i+=t.offsetTop-t.scrollTop}return{x:e,y:i}};Simulator.prototype.handleMouseUp=function(t){this.mouseDown=false;if(this.mouseJoint){this.pscene.world.DestroyJoint(this.mouseJoint);this.mouseJoint=null}};Simulator.prototype.handleMouseMove=function(t){this.mousePoint.x=(t.clientX-this.canvas_position.x)/this.draw_scale;this.mousePoint.y=(t.clientY-this.canvas_position.y)/this.draw_scale;if(this.mouseDown&&!this.playing){if(this.was_autopaused)this.play();else this.pscene.step()}if(this.draw_pos&&!this.mouseDown&&!this.playing)this.draw()};Simulator.prototype.getBodyAtMouse=function(){var t=new h;var e=this.mousePoint;t.lowerBound.Set(e.x-.001,e.y-.001);t.upperBound.Set(e.x+.001,e.y+.001);var s=null;var o=function(t){var o=t.GetBody();if(o.GetType()!=i.b2_staticBody&&t.GetShape().TestPoint(o.GetTransform(),e)){s=o;return false}return true};this.pscene.world.QueryAABB(o,t);return s};Simulator.prototype.updateInteraction=function(){if(this.mouseDown&&!this.mouseJoint){var t=this.getBodyAtMouse();if(t){var e=new w;e.bodyA=this.pscene.world.GetGroundBody();e.bodyB=t;e.target=this.mousePoint;e.collideConnected=true;e.maxForce=300*t.GetMass();this.mouseJoint=this.pscene.world.CreateJoint(e);t.SetAwake(true)}}if(this.mouseJoint){if(this.mouseDown){this.mouseJoint.SetTarget(this.mousePoint)}else{this.pscene.world.DestroyJoint(this.mouseJoint);this.mouseJoint=null}}};Simulator.prototype.draw=function(){if(!this.drawing)return;this.pscene.world.DrawDebugData();if(this.show_time||this.show_pos){var t="";if(this.show_pos&&this.mousePoint)t+=" x="+this.mousePoint.x.toFixed(2)+" y="+this.mousePoint.y.toFixed(2);if(this.show_time)t+=" t="+this.pscene.getTime().toFixed(2);this.ctx.fillStyle="black";this.ctx.fillText(t,5,10)}};t.Simulator=Simulator;Box2D.Common.b2Settings.b2_linearSleepTolerance=.1;Box2D.Common.b2Settings.b2_angularSleepTolerance=20/180*Math.PI;var S=function(t,e){this.world=t;this.world.curr_time=this.world.curr_time||0;this.world.PushState();this.dt=e||1/50;this.onWorldChange=new b;this.emit_changes=true};S.prototype.pushState=function(){this.world.PushState()};S.prototype.popState=function(){this.world.PopState();if(this.emit_changes)this.onWorldChange.emit(this.world.curr_time)};S.prototype.getState=function(){return this.world.GetState()};S.prototype.setState=function(t){this.world.SetState(t);if(this.emit_changes)this.onWorldChange.emit(this.world.curr_time)};S.prototype.reset=function(){this.popState();this.pushState()};S.prototype.getTime=function(){return this.world.curr_time};S.prototype.seek=function(t){if(this.world.curr_time>t)this.reset();this.simulate(t-this.world.curr_time)};S.prototype.clearForces=function(){this.world.ClearForces()};S.prototype.step=function(t){t=t||this.dt;try{this.world.Step(t,10,10)}catch(e){console.log("caught error",e,"during Box2D simulation step");console.log("trying again after finding new contacts...");var i=this.world.m_contactManager.m_broadPhase;this.forEachBody(function(t){for(var e=t.m_fixtureList;e;e=e.m_next){if(!e.m_proxy){console.log(t,e,"has no m_proxy set. Creating it now...");e.CreateProxy(i,t.m_xf)}}});this.step(t)}this.world.curr_time+=t;if(this.emit_changes)this.onWorldChange.emit(this.world.curr_time);return t};S.prototype.simulate=function(t){var e=0;while(e+this.dt<t)e+=this.step();var i=t-e;if(i>.001)this.step(i)};S.prototype.simulateUntilSleep=function(t){var t=t||Infinity;var e=0;while(e<=t&&this.countAwake()>0)e+=this.step();return e};S.prototype.analyzeFuture=function(t,e,i,s){if(t<0)throw"You are mistaking the past for the future.";var o=this.emit_changes;this.emit_changes=false;this.pushState();if(e)e();if(t>0){if(s)this.simulateUntilSleep(t);else this.simulate(t)}var r=i();this.popState();this.emit_changes=o;return r};S.prototype.forEachBody=function(t){for(var e=this.world.m_bodyList;e;e=e.m_next){if(e.master_obj)t(e)}};S.prototype.forEachDynamicBody=function(t){for(var e=this.world.m_bodyList;e;e=e.m_next){if(e.GetType()==i.b2_dynamicBody)t(e)}};S.prototype.getKineticEnergy=function(){var t=0;this.world.forEachDynamicBody(function(e){t+=.5*(e.m_I*e.m_angularVelocity*e.m_angularVelocity+e.m_mass*e.m_linearVelocity.Length()*e.m_linearVelocity.Length())});return t};S.prototype.getBodyDistance=function(t,e){e=e||t.bodystates[t.bodystates.length-1].m_xf;if(t.m_fixtureList.m_shape.GetType()==o.e_circleShape){var i=t.m_xf.position.Copy();i.Subtract(e.position);return i.Length()}else{return this.meanPointDistance(t.m_fixtureList.m_shape.GetVertices(),t.m_xf,e)}};S.prototype.meanPointDistance=function(t,e,i){var s=0;for(var o=0;o<t.length;o++){var r=t[o];var n=r.Transformed(e);n.Subtract(r.Transformed(i));s+=n.Length()}return s/t.length};S.prototype.wakeUp=function(){for(var t=this.world.m_bodyList;t;t=t.m_next)t.SetAwake(true)};S.prototype.countAwake=function(){var t=0;this.forEachDynamicBody(function(e){if(e.IsAwake())t++});return t};var b=function(){this.listeners=[]};b.prototype.addListener=function(t){this.listeners.push(t)};b.prototype.removeListener=function(t){var e=this.listeners.indexOf(t);if(e>=0)Array.remove(this.listeners,t)};b.prototype.removeAll=function(){this.listeners=[]};b.prototype.emit=function(){for(var t=0;t<this.listeners.length;t++){this.listeners[t].apply(this.listeners[t],arguments)}};t.PhysicsScene=S;var D=function(){var t="s2p-";var e={};var i=function(t){var e;if(window.XMLHttpRequest){e=new XMLHttpRequest}else{e=new ActiveXObject("Microsoft.XMLHTTP")}if(e){e.open("GET",t,false);e.send(null);return e.responseText}return null};e.ajaxGetUrl=i;var s=function(t){if(window.DOMParser){var e=new DOMParser;return e.parseFromString(t,"image/svg+xml")}else{t=t.replace(/<!DOCTYPE svg[^>]*>/,"");var i=new ActiveXObject("Microsoft.XMLDOM");i.async="false";i.loadXML(t);return i}};e.parseXml=s;var o=function(t,e){var i={};for(var s=0;s<t.style.length;++s){var o=t.style.item(s);i[o]=t.style.getPropertyValue(o)}return i};var r=function(t){return(Point.len(t.a,t.b)+Point.len(t.c,t.d))/2};var n=function(t,e){e=e||100;var n=i(t);var p=s(n);if(!p)throw"Error parsing "+n;var c=l(p,"hidden_svg_div");var u=[];var m=function(t,e){var i=t.style["stroke-width"];if(!i)return;t.style["stroke-width"]=i.replace(/^[0-9]*\.?[0-9]+/,function(t){return Number(t)*e})};var f=c.getElementsByTagName("rect");for(var y=0;y<f.length;y++){var d=f[y];var _=Polygon.fromSVGRect(d);_.svg_transform=d.getCTM();_.style=o(d);m(_,r(_.svg_transform));u.push(_)}var v=h(u);v.is_frame=true;u=u.filter(function(t){return!t.is_frame});var g=c.getElementsByTagName("path");for(var y=0;y<g.length;y++){var w=g[y];var _=Circle.fromSVGPath(w,false)||Polygon.fromSVGPath(w,1,false);if(_ instanceof Polygon){_.merge_vertices({min_dist:1,min_vertex_count:2})}_.svg_transform=w.getCTM();_.style=o(w);m(_,r(_.svg_transform));u.push(_)}u.forEach(function(t){var e=t.style.stroke;t.movable=!(e=="#000000"||e=="#000"||e=="black"||e=="rgb(0, 0, 0)")});a([v],0,0,1,c);var x=100/Math.abs(v.pts[0].x-v.pts[1].x),S=-Math.min(v.pts[0].x,v.pts[1].x),b=-Math.min(v.pts[0].y,v.pts[2].y);a(u,S,b,x,c);a([v],S,b,x,c);return new SVGScene(u,v,e)};e.parseFile=n;var a=function(t,e,i,s,o){var r=o.createSVGPoint(0,0);t.forEach(function(t){var o=function(o){r.x=o.x;r.y=o.y;if(t.svg_transform)r=r.matrixTransform(t.svg_transform);o.x=s*r.x+e;o.y=s*r.y+i};if(t instanceof Circle){var n=t.centroid();o(n);t.x=n.x;t.y=n.y;if(t.svg_transform)t.r*=Math.abs(t.svg_transform.a)}else if(t instanceof Polygon)t.pts.forEach(o);else throw"Unkown object type";delete t.svg_transform})};var h=function(t){var e=0,i=null;for(var s=0;s<t.length;s++){var o=t[s].svg_transform.a;var r=Math.abs(t[s].area()*o*o);if(r>e){e=r;i=t[s]}}return i};var l=function(t,e){var i=document.getElementById(e);if(!i){i=document.body.appendChild(document.createElement("div"));i.setAttribute("id",e);i.setAttribute("style","position:absolute;width:1px;height:1px;overflow:hidden;left:-10px;")}else{var s;while(s=i.childNodes[0]){i.removeChild(s)}}return i.appendChild(t.rootElement)};return e}();SVGScene=function(t,e,i){this.shapes=t||[];this.frame=e;this.shapes.push(e);this.setIds();this.width=100;this.height=100;this.friction=.3;this.restitution=.1;this.pixels_per_unit=i;this.moveToOrigin()};SVGScene.prototype.adjustStrokeWidth=function(t){var e=/^[0-9]*\.?[0-9]+/;for(var i=0;i<this.shapes.length;i++){var s=this.shapes[i];var o=1;if(e.test(s.style["stroke-width"])){o=Number(e.exec(s.style["stroke-width"])[0])}var r=s.bounding_box();var n=(r.width+o)/(r.width+t);var a=(r.height+o)/(r.height+t);if(s instanceof Polygon){if(s.movable){s.pts.forEach(function(t){t.x*=n;t.y*=a});s.style["stroke-width"]=t}else if(s.id=="_"){s.pts.forEach(function(e){e.y+=(t-o)/2});s.style["stroke-width"]=t}}else if(s instanceof Circle){s.style["stroke-width"]=t;s.r=s.r*n}}};SVGScene.prototype.setIds=function(){for(var t=0;t<this.shapes.length;t++){if(this.shapes[t].movable)this.shapes[t].id=t;else if(this.shapes[t]==this.frame)this.shapes[t].id="|";else this.shapes[t].id="_"}};SVGScene.prototype.moveToOrigin=function(){for(var t=0;t<this.shapes.length;t++){var e=this.shapes[t];if(!(e instanceof Polygon))continue;var i=e.centroid();e.pts.forEach(function(t){t.Sub(i)});e.x=i.x;e.y=i.y;e.rot=0}};SVGScene.prototype.renderInSvg=function(t,e,i,s,o,r){var n=t.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("transform","translate("+i+","+s+") scale("+o+")");e.appendChild(n);var a=t.createElementNS("http://www.w3.org/2000/svg","rect");for(var h=0;h<this.shapes.length;h++){var l=this.shapes[h];var p=l.renderInSvg(document,n);for(var c in l.style)p.style.setProperty(c,l.style[c]);if(r&&this.shapes[h].movable){d3.select(e).append("text").style("fill","black").attr("x",l.x*o).attr("y",l.y*o).attr("text-anchor","middle").attr("dominant-baseline","central").text(h)}}};t.SVGSceneParser=D;return t}();